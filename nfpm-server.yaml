name: backuppc-tunnel-server
arch: amd64
platform: linux
version: ${VERSION}
maintainer: Steffen Heil <steffen.heil@secforge.de>
description: BackupPC WebSocket tunnel server for client-initiated backups
vendor: ""
homepage: https://github.com/steffen-heil-secforge/backuppc-wstunnel
license: MIT

contents:
  - src: bin/backuppc-tunnel-server
    dst: /usr/local/bin/backuppc-tunnel-server
    file_info:
      mode: 0755

  - src: config/backuppc-tunnel.service
    dst: /etc/systemd/system/backuppc-tunnel.service
    file_info:
      mode: 0644

  - src: scripts/init-ca.sh
    dst: /usr/share/backuppc-tunnel/init-ca.sh
    file_info:
      mode: 0755

  - src: scripts/register-client.sh
    dst: /usr/share/backuppc-tunnel/register-client.sh
    file_info:
      mode: 0755

  - dst: /etc/backuppc-tunnel
    type: dir
    file_info:
      mode: 0755

scripts:
  postinstall: |
    #!/bin/sh
    systemctl daemon-reload
    echo ""
    echo "backuppc-tunnel-server installed."
    echo ""
    echo "Next steps:"
    echo "  1. Initialize CA:  /usr/share/backuppc-tunnel/init-ca.sh /etc/backuppc-tunnel your-domain.com"
    echo "  2. Register clients: /usr/share/backuppc-tunnel/register-client.sh hostname"
    echo "  3. Start server:   systemctl enable --now backuppc-tunnel"

  preremove: |
    #!/bin/sh
    systemctl stop backuppc-tunnel 2>/dev/null || true
    systemctl disable backuppc-tunnel 2>/dev/null || true

  postremove: |
    #!/bin/sh
    systemctl daemon-reload
